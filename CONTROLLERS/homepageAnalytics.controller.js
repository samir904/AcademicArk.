// CONTROLLERS/homepageAnalytics.controller.js
import HomepageSectionEvent from "../MODELS/HomepageSectionEvent.model.js";
import HomepageAnalyticsSnapshot from "../MODELS/HomepageAnalyticsSnapshot.model.js";

/**
 * ðŸ“¥ LOG HOMEPAGE EVENT
 * POST /api/v1/homepage/event
 * Called from frontend â€” batched every 5 seconds
 */
export const logHomepageEvent = async (req, res) => {
  try {
    const userId    = req.user.id;
    const { events } = req.body;  // â† array of events (batched)

    if (!Array.isArray(events) || !events.length) {
      return res.status(400).json({ success: false, message: "No events" });
    }

    // â”€â”€ Validate + sanitize
    const docs = events
      .filter(e => e.section && e.eventType)
      .map(e => ({
        userId,
        sessionId:  e.sessionId  || null,
        section:    e.section,
        eventType:  e.eventType,
        clickMeta:  e.clickMeta  || {},
        deviceType: e.deviceType || "DESKTOP",
        createdAt:  new Date(),
      }));

    // â”€â”€ Bulk insert â€” non-blocking
    if (docs.length) {
      HomepageSectionEvent.insertMany(docs, { ordered: false })
        .catch(err => console.error("Event insertMany error:", err));
    }

    res.status(200).json({ success: true });

  } catch (err) {
    console.error("logHomepageEvent error:", err);
    res.status(500).json({ success: false });
  }
};

/**
 * ðŸ“Š GET ADMIN ANALYTICS
 * GET /api/v1/admin/homepage-analytics?days=7
 */
export const getHomepageAnalytics = async (req, res) => {
  try {
    const days  = parseInt(req.query.days) || 7;
    const since = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

    // â”€â”€ Use snapshots for speed (generated by cron)
    const snapshots = await HomepageAnalyticsSnapshot.find({
      generatedAt: { $gte: since }
    })
      .sort({ date: -1 })
      .lean();

    // â”€â”€ If no snapshot yet, compute live (first time)
    if (!snapshots.length) {
      const live = await computeLiveAnalytics(since);
      return res.status(200).json({ success: true, data: live, fromSnapshot: false });
    }

    res.status(200).json({ success: true, data: snapshots, fromSnapshot: true });

  } catch (err) {
    console.error("getHomepageAnalytics error:", err);
    res.status(500).json({ success: false });
  }
};

/**
 * âš™ï¸ GENERATE DAILY SNAPSHOT (called by cron at midnight)
 */
export const generateDailySnapshot = async () => {
  try {
    const today     = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow  = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dateStr   = today.toISOString().split("T")[0];

    // â”€â”€ Aggregate all events for today
    const [sectionStats, topCards, deviceStats, overview] = await Promise.all([

      // Per-section CTR
      HomepageSectionEvent.aggregate([
        { $match: { createdAt: { $gte: today, $lt: tomorrow } } },
        { $group: {
          _id:         { section: "$section", eventType: "$eventType" },
          count:       { $sum: 1 }
        }},
      ]),

      // Top clicked cards
      HomepageSectionEvent.aggregate([
        { $match: {
          createdAt: { $gte: today, $lt: tomorrow },
          eventType: "CLICK",
          "clickMeta.resourceId": { $ne: null }
        }},
        { $group: { _id: "$clickMeta.resourceId", clicks: { $sum: 1 } }},
        { $sort: { clicks: -1 }},
        { $limit: 10 },
        { $lookup: {
          from: "notes",
          localField: "_id",
          foreignField: "_id",
          as: "note"
        }},
        { $unwind: { path: "$note", preserveNullAndEmptyArrays: true }},
        { $project: {
          resourceId: "$_id",
          title:      "$note.title",
          clicks:     1
        }}
      ]),

      // Device breakdown
      HomepageSectionEvent.aggregate([
        { $match: {
          createdAt: { $gte: today, $lt: tomorrow },
          eventType: "IMPRESSION"
        }},
        { $group: { _id: "$deviceType", count: { $sum: 1 } }},
      ]),

      // Overview
      HomepageSectionEvent.aggregate([
        { $match: { createdAt: { $gte: today, $lt: tomorrow } }},
        { $group: {
          _id:           null,
          totalImpressions: { $sum: { $cond: [{ $eq: ["$eventType","IMPRESSION"] }, 1, 0] }},
          totalClicks:      { $sum: { $cond: [{ $eq: ["$eventType","CLICK"] }, 1, 0] }},
          uniqueVisitors:   { $addToSet: "$userId" },
        }},
        { $project: {
          totalImpressions: 1,
          totalClicks:      1,
          uniqueVisitors:   { $size: "$uniqueVisitors" },
          overallCTR: {
            $cond: [
              { $gt: ["$totalImpressions", 0] },
              { $multiply: [{ $divide: ["$totalClicks", "$totalImpressions"] }, 100] },
              0
            ]
          }
        }}
      ]),
    ]);

    // â”€â”€ Build sections array
    const sectionMap = {};
    sectionStats.forEach(({ _id, count }) => {
      const key = _id.section;
      if (!sectionMap[key]) sectionMap[key] = { impressions: 0, clicks: 0 };
      if (_id.eventType === "IMPRESSION") sectionMap[key].impressions = count;
      if (_id.eventType === "CLICK")      sectionMap[key].clicks      = count;
    });

    const sections = Object.entries(sectionMap).map(([section, data]) => ({
      section,
      impressions: data.impressions,
      clicks:      data.clicks,
      ctr: data.impressions > 0
        ? parseFloat(((data.clicks / data.impressions) * 100).toFixed(2))
        : 0
    })).sort((a, b) => b.ctr - a.ctr);

    // â”€â”€ Device breakdown
    const deviceBreakdown = { mobile: 0, tablet: 0, desktop: 0 };
    deviceStats.forEach(d => {
      deviceBreakdown[d._id.toLowerCase()] = d.count;
    });

    // â”€â”€ Upsert snapshot
    await HomepageAnalyticsSnapshot.findOneAndUpdate(
      { date: dateStr },
      {
        date:             dateStr,
        overview:         overview[0] || {},
        sections,
        topClickedCards:  topCards,
        deviceBreakdown,
        generatedAt:      new Date(),
      },
      { upsert: true, new: true }
    );

    console.log(`âœ… Homepage snapshot generated for ${dateStr}`);

  } catch (err) {
    console.error("generateDailySnapshot error:", err);
  }
};
